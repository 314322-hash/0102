<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½é™¤æ¿•æ¡¶ç›£æ§ä¸­å¿ƒ (AI+Firebase)</title>
    <!-- è¼‰å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ä½¿ç”¨ Inter å­—é«” -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fcfcfc; 
        }
        .humidity-gauge {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        /* è‡ªè¨‚é¸å–®æ¨£å¼ */
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23b45309' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            appearance: none;
        }
        /* Modal å‹•ç•« */
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 200ms ease-out, transform 200ms ease-out;
        }
        .modal-exit {
            opacity: 1;
            transform: scale(1);
        }
        .modal-exit-active {
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 150ms ease-in, transform 150ms ease-in;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <header class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
            <h1 class="text-3xl font-extrabold text-amber-800 flex items-center gap-2">
                <span class="text-4xl">ğŸ’§</span> æ™ºèƒ½é™¤æ¿•æ¡¶ä¸­æ§å°
            </h1>
            <p id="user-id-display" class="text-xs text-gray-400 mt-1">ä½¿ç”¨è€… ID: è¼‰å…¥ä¸­...</p>
        </div>

        <!-- NEW: è£ç½®é¸æ“‡å™¨ -->
        <div class="flex items-center gap-2 bg-white p-2 rounded-xl shadow-sm border border-stone-200">
            <label for="device-select" class="text-sm font-semibold text-gray-600 pl-2">é¸æ“‡è¨­å‚™ï¼š</label>
            <select id="device-select" class="bg-amber-50 border border-amber-200 text-amber-900 text-sm rounded-lg focus:ring-amber-500 focus:border-amber-500 block p-2.5 font-bold min-w-[150px]">
                <option value="" disabled selected>è¼‰å…¥ä¸­...</option>
            </select>
            <button id="add-device-btn" class="p-2.5 text-white bg-amber-600 hover:bg-amber-700 rounded-lg text-sm font-medium transition-colors" title="æ–°å¢é™¤æ¿•æ¡¶">
                + æ–°å¢
            </button>
        </div>
    </header>

    <!-- ä¸»å…§å®¹å€ -->
    <main class="grid grid-cols-1 lg:grid-cols-3 gap-6 relative">
        
        <!-- è¼‰å…¥é®ç½© (åˆ‡æ›è£ç½®æ™‚é¡¯ç¤º) -->
        <div id="loading-overlay" class="absolute inset-0 bg-white/80 z-50 flex items-center justify-center rounded-xl backdrop-blur-sm hidden">
            <div class="text-amber-800 font-bold text-xl animate-pulse">æ­£åœ¨é€£ç·šè£ç½®...</div>
        </div>

        <!-- å·¦å´ï¼šæ§åˆ¶é¢æ¿ & æ’ç¨‹è¨­å®š -->
        <div id="left-column" class="space-y-6 order-1 lg:order-1">
            
            <!-- 1. æ ¸å¿ƒæ§åˆ¶é¢æ¿ -->
            <div id="control-panel" class="bg-white p-6 rounded-xl shadow-xl border-t-4 border-amber-600">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-2xl font-bold text-amber-900">æ ¸å¿ƒæ§åˆ¶</h2>
                    <div class="flex items-center gap-2 bg-stone-50 px-3 py-1.5 rounded-lg border border-stone-200">
                        <span id="current-device-name" class="text-sm font-bold text-stone-700">--</span>
                        <button id="rename-device-btn" class="text-stone-400 hover:text-amber-600 transition-colors p-1" title="ä¿®æ”¹è£ç½®åç¨±">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                              <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="space-y-6">
                    
                    <!-- ç‹€æ…‹é¡¯ç¤º -->
                    <div class="p-4 rounded-lg bg-gray-100 transition-colors duration-300" id="status-card">
                        <p class="text-xs font-bold text-gray-500 uppercase tracking-wider">Status</p>
                        <div class="flex items-center space-x-2 mt-1">
                            <span id="device-status-indicator" class="w-3 h-3 rounded-full bg-gray-400 shadow-sm"></span>
                            <span id="device-status-text" class="text-lg font-bold text-gray-700">é›¢ç·š</span>
                        </div>
                    </div>

                    <!-- ç›®æ¨™æ¿•åº¦è¨­å®š -->
                    <div>
                        <label for="target-humidity" class="block text-sm font-medium text-gray-700 mb-2 flex justify-between">
                            <span>ç›®æ¨™æ¿•åº¦è¨­å®š</span>
                            <span class="text-amber-700 font-bold"><span id="target-humidity-value">55</span>%</span>
                        </label>
                        <input type="range" id="target-humidity" min="30" max="80" value="55" step="1" 
                               class="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer accent-amber-600">
                        <div class="flex justify-between text-xs text-gray-400 mt-1">
                            <span>30% (ä¹¾ç‡¥)</span>
                            <span>80% (æ½®æ¿•)</span>
                        </div>
                    </div>

                    <!-- é‹è¡Œæ¨¡å¼é¸æ“‡ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é‹è¡Œæ¨¡å¼</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button data-mode="Auto" class="mode-btn px-4 py-3 bg-stone-200 text-stone-600 font-bold rounded-lg hover:bg-stone-300 transition duration-150 flex items-center justify-center gap-2">
                                <span>ğŸ¤–</span> æ™ºèƒ½ (AI)
                            </button>
                            <button data-mode="Manual" class="mode-btn px-4 py-3 bg-stone-200 text-stone-600 font-bold rounded-lg hover:bg-stone-300 transition duration-150 flex items-center justify-center gap-2">
                                <span>âœ‹</span> æ‰‹å‹•
                            </button>
                        </div>
                    </div>

                    <!-- å•Ÿå‹•/åœæ­¢æŒ‰éˆ• -->
                    <button id="toggle-run-btn" 
                            class="w-full py-4 text-xl font-bold text-white rounded-xl shadow-lg transition duration-300 transform hover:scale-[1.02] active:scale-95 bg-lime-600 hover:bg-lime-700 flex justify-center items-center gap-2">
                        <span>ğŸš€</span> å•Ÿå‹•é™¤æ¿•æ¡¶
                    </button>
                </div>
            </div>

            <!-- 2. æ’ç¨‹èˆ‡å®šæ™‚ -->
            <div class="bg-white p-6 rounded-xl shadow-xl">
                <h2 class="text-lg font-bold mb-4 text-amber-900 border-b pb-2 flex items-center gap-2">
                    <span>â°</span> æ’ç¨‹è¨­å®š
                </h2>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <label class="text-gray-600 text-sm font-medium">é–‹æ©Ÿæ™‚é–“</label>
                        <div class="flex items-center space-x-2">
                            <input type="time" id="schedule-start-time" class="border border-stone-300 rounded px-2 py-1 text-amber-800 text-sm bg-stone-50">
                            <button id="set-start-schedule-btn" class="px-3 py-1 bg-stone-200 text-stone-600 rounded text-xs font-bold hover:bg-stone-300">å„²å­˜</button>
                        </div>
                    </div>
                     <div class="flex justify-between items-center">
                        <label class="text-gray-600 text-sm font-medium">é—œæ©Ÿæ™‚é–“</label>
                        <div class="flex items-center space-x-2">
                            <input type="time" id="schedule-stop-time" class="border border-stone-300 rounded px-2 py-1 text-amber-800 text-sm bg-stone-50">
                            <button id="set-stop-schedule-btn" class="px-3 py-1 bg-stone-200 text-stone-600 rounded text-xs font-bold hover:bg-stone-300">å„²å­˜</button>
                        </div>
                    </div>
                    <div class="pt-2 border-t border-dashed border-gray-200">
                        <p id="current-schedule" class="text-xs text-gray-400 text-center">æ­£åœ¨åŒæ­¥æ’ç¨‹...</p>
                    </div>
                </div>
            </div>

        </div>

        <!-- ä¸­é–“ï¼šæ™ºèƒ½é™¤æ¿•æ¡¶é››å½¢èˆ‡æ•¸æ“šåœ–è¡¨ -->
        <div class="space-y-6 order-2 lg:order-2">

            <!-- 1. ç‹€æ…‹ç¸½è¦½ -->
            <div class="bg-white p-6 rounded-xl shadow-xl relative overflow-hidden">
                <div class="absolute top-0 right-0 w-24 h-24 bg-amber-50 rounded-bl-full -z-0"></div>
                <h2 class="text-2xl font-bold mb-4 text-amber-900 border-b pb-2 z-10 relative">è£ç½®ç‹€æ…‹ç›£æ§</h2>
                
                <div class="humidity-gauge h-64 mb-6 p-2 relative">
                    <!-- æ¿•åº¦é¡¯ç¤ºåœ“ç›¤ -->
                    <canvas id="humidity-canvas" class="w-full h-full object-contain drop-shadow-md"></canvas>
                    <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none mt-4">
                        <p class="text-5xl font-black text-amber-800 tracking-tighter" id="current-humidity-display">--%</p>
                        <p class="text-sm font-medium text-gray-400 mt-1">ç’°å¢ƒç›¸å°æ¿•åº¦</p>
                    </div>
                </div>

                <!-- 2x2 æ„Ÿæ¸¬å™¨æ•¸æ“š -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-stone-50 p-4 rounded-xl border border-stone-100 text-center transition hover:shadow-md">
                        <p class="text-xs text-gray-500 mb-1">ğŸ’§ æ°´ç®±æ°´ä½</p>
                        <p class="text-lg font-bold text-amber-600" id="water-level-display">--</p>
                    </div>
                    <div class="bg-stone-50 p-4 rounded-xl border border-stone-100 text-center transition hover:shadow-md">
                        <p class="text-xs text-gray-500 mb-1">ğŸ§  AI æ±ºç­–</p>
                        <p class="text-lg font-bold text-lime-700" id="ai-decision-display">--</p>
                    </div>
                    <div class="bg-stone-50 p-4 rounded-xl border border-stone-100 text-center transition hover:shadow-md">
                        <p class="text-xs text-gray-500 mb-1">ğŸŒ«ï¸ PM2.5</p>
                        <p class="text-lg font-bold text-amber-700" id="pm25-display">--</p>
                    </div>
                    <div class="bg-stone-50 p-4 rounded-xl border border-stone-100 text-center transition hover:shadow-md">
                        <p class="text-xs text-gray-500 mb-1">ğŸ•¸ï¸ æ¿¾ç¶²å¥åº·</p>
                        <p class="text-lg font-bold text-amber-700" id="filter-life-display">--</p>
                    </div>
                </div>
            </div>

            <!-- 2. æ­·å²æ•¸æ“šè¶¨å‹¢ -->
            <div class="bg-white p-6 rounded-xl shadow-xl">
                <h2 class="text-lg font-bold mb-4 text-amber-900 border-b pb-2 flex justify-between items-center">
                    <span>ğŸ“ˆ 24H æ¿•åº¦è¶¨å‹¢</span>
                    <span class="text-xs font-normal text-gray-400 bg-gray-100 px-2 py-1 rounded">æ¨¡æ“¬æ•¸æ“š</span>
                </h2>
                <div class="h-40 flex items-end justify-between px-2 gap-1 pb-2 border-b border-l border-gray-300" id="trend-chart-placeholder">
                    <!-- Javascript will generate bars here -->
                </div>
                <div class="flex justify-between text-xs text-gray-400 mt-2">
                    <span>24h ago</span>
                    <span>12h ago</span>
                    <span>Now</span>
                </div>
            </div>

        </div>

        <!-- å³å´ï¼šæ¿¾ç¶²ç‹€æ…‹ & ç´€éŒ„å€ -->
        <div class="space-y-6 order-3 lg:order-3">
            
             <!-- 1. ç¶­è­·æé†’ -->
             <div class="bg-white p-6 rounded-xl shadow-xl">
                <h2 class="text-lg font-bold mb-4 text-amber-900 border-b pb-2">ğŸ› ï¸ ç¶­è­·èˆ‡ä¿é¤Š</h2>
                
                <div id="filter-status-alert" class="p-4 rounded-lg bg-stone-100 text-stone-600 mb-4 border-l-4 border-stone-400">
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold text-sm">æ¿¾ç¶²ç‹€æ…‹</span>
                        <span id="filter-life-text" class="text-xs bg-white px-2 py-0.5 rounded shadow-sm">è‰¯å¥½</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                        <div id="filter-progress-bar" class="bg-amber-600 h-2.5 rounded-full" style="width: 100%"></div>
                    </div>
                </div>

                <button id="reset-filter-btn" 
                        class="w-full py-2 text-sm font-semibold text-gray-600 bg-gray-100 rounded-lg border border-gray-300 hover:bg-white hover:text-amber-600 hover:border-amber-300 transition-all disabled:opacity-50">
                    â†» æ›´æ›æ¿¾ç¶²å¾Œé‡ç½®
                </button>
            </div>

            <!-- 2. å¤–éƒ¨ç’°å¢ƒ -->
            <div class="bg-gradient-to-br from-sky-50 to-white p-6 rounded-xl shadow-xl border border-sky-100">
                <h2 class="text-lg font-bold mb-4 text-sky-900 border-b border-sky-200 pb-2">â˜ï¸ å¤–éƒ¨å¤©æ°£è³‡è¨Š</h2>
                <div class="flex justify-between items-center mb-4">
                    <div class="text-center">
                        <p class="text-3xl font-bold text-sky-600" id="external-temp">--Â°C</p>
                        <p class="text-xs text-sky-400">æ°£æº«</p>
                    </div>
                    <div class="h-8 w-px bg-sky-200"></div>
                    <div class="text-center">
                        <p class="text-3xl font-bold text-blue-600" id="external-humidity">--%</p>
                        <p class="text-xs text-blue-400">æ¿•åº¦</p>
                    </div>
                </div>
                <div class="bg-white/60 p-3 rounded-lg text-center backdrop-blur-sm">
                    <p class="text-sm font-medium text-sky-800" id="weather-forecast">è¼‰å…¥ä¸­...</p>
                </div>
            </div>

            <!-- 3. è£ç½®å°ˆå±¬ç´€éŒ„ -->
            <div class="bg-white p-6 rounded-xl shadow-xl flex-grow flex flex-col min-h-[300px]">
                <h2 class="text-lg font-bold mb-4 text-amber-900 border-b pb-2 flex justify-between items-center">
                    <span>ğŸ“‹ è£ç½®æ—¥èªŒ</span>
                    <button id="clear-logs-btn" class="text-xs text-gray-400 hover:text-red-500">æ¸…é™¤é¡¯ç¤º</button>
                </h2>
                <div id="log-area" class="space-y-3 overflow-y-auto max-h-[400px] pr-2 flex-grow scrollbar-thin scrollbar-thumb-stone-300 scrollbar-track-stone-100">
                    <!-- Logs go here -->
                </div>
            </div>
            
        </div>

    </main>

    <!-- æ–°å¢åœ°é» Modal (é è¨­éš±è—) -->
    <div id="add-device-modal" class="fixed inset-0 z-[60] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <!-- èƒŒæ™¯é®ç½© -->
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" id="modal-backdrop"></div>

        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                    <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-amber-100 sm:mx-0 sm:h-10 sm:w-10">
                                <svg class="h-6 w-6 text-amber-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                                </svg>
                            </div>
                            <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                                <h3 class="text-base font-semibold leading-6 text-gray-900" id="modal-title">æ–°å¢é™¤æ¿•ç›£æ§é»</h3>
                                <div class="mt-2">
                                    <p class="text-sm text-gray-500 mb-4">è«‹é¸æ“‡ä¸€å€‹åœ°é»æˆ–è‡ªè¡Œè¼¸å…¥åç¨±ï¼Œæˆ‘å€‘å°‡ç‚ºè©²ä½ç½®å»ºç«‹ç¨ç«‹çš„ç›£æ§å„€è¡¨æ¿ã€‚</p>
                                    
                                    <!-- å¿«é€Ÿé¸æ“‡æŒ‰éˆ•å€ -->
                                    <div class="grid grid-cols-3 gap-2 mb-4">
                                        <button class="quick-add-btn py-2 px-3 bg-stone-100 hover:bg-amber-100 hover:text-amber-800 text-stone-600 rounded text-sm font-medium transition-colors border border-transparent hover:border-amber-200">å®¢å»³</button>
                                        <button class="quick-add-btn py-2 px-3 bg-stone-100 hover:bg-amber-100 hover:text-amber-800 text-stone-600 rounded text-sm font-medium transition-colors border border-transparent hover:border-amber-200">ä¸»è‡¥å®¤</button>
                                        <button class="quick-add-btn py-2 px-3 bg-stone-100 hover:bg-amber-100 hover:text-amber-800 text-stone-600 rounded text-sm font-medium transition-colors border border-transparent hover:border-amber-200">å…’ç«¥æˆ¿</button>
                                        <button class="quick-add-btn py-2 px-3 bg-stone-100 hover:bg-amber-100 hover:text-amber-800 text-stone-600 rounded text-sm font-medium transition-colors border border-transparent hover:border-amber-200">æµ´å®¤</button>
                                        <button class="quick-add-btn py-2 px-3 bg-stone-100 hover:bg-amber-100 hover:text-amber-800 text-stone-600 rounded text-sm font-medium transition-colors border border-transparent hover:border-amber-200">åœ°ä¸‹å®¤</button>
                                        <button class="quick-add-btn py-2 px-3 bg-stone-100 hover:bg-amber-100 hover:text-amber-800 text-stone-600 rounded text-sm font-medium transition-colors border border-transparent hover:border-amber-200">æ›¸æˆ¿</button>
                                        <button class="quick-add-btn py-2 px-3 bg-stone-100 hover:bg-amber-100 hover:text-amber-800 text-stone-600 rounded text-sm font-medium transition-colors border border-transparent hover:border-amber-200">å„²è—å®¤</button>
                                        <button class="quick-add-btn py-2 px-3 bg-stone-100 hover:bg-amber-100 hover:text-amber-800 text-stone-600 rounded text-sm font-medium transition-colors border border-transparent hover:border-amber-200">æ›´è¡£é–“</button>
                                        <button class="quick-add-btn py-2 px-3 bg-stone-100 hover:bg-amber-100 hover:text-amber-800 text-stone-600 rounded text-sm font-medium transition-colors border border-transparent hover:border-amber-200">é™½å°</button>
                                    </div>

                                    <div class="relative">
                                        <div class="absolute inset-0 flex items-center" aria-hidden="true">
                                          <div class="w-full border-t border-gray-300"></div>
                                        </div>
                                        <div class="relative flex justify-center">
                                          <span class="bg-white px-2 text-xs text-gray-500">æˆ–è‡ªè¨‚åç¨±</span>
                                        </div>
                                    </div>

                                    <input type="text" id="new-device-name-input" placeholder="ä¾‹å¦‚ï¼šè²“å’ªæˆ¿é–“..." 
                                           class="mt-3 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-amber-600 sm:text-sm sm:leading-6">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                        <button type="button" id="confirm-add-device-btn" class="inline-flex w-full justify-center rounded-md bg-amber-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-amber-500 sm:ml-3 sm:w-auto">å»ºç«‹åœ°é»</button>
                        <button type="button" id="cancel-add-device-btn" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase æ¨¡çµ„è¼‰å…¥ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, limit, orderBy, serverTimestamp, getDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase é…ç½® ---
        // ä½¿ç”¨ç³»çµ±ç’°å¢ƒè®Šæ•¸ __firebase_config (å¦‚æœå­˜åœ¨)ï¼Œå¦å‰‡ä½¿ç”¨é è¨­å€¼
        // é€™æ˜¯è§£æ±ºæ¬Šé™å•é¡Œçš„é—œéµ Fix
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyA2jROd4tGqCew067vn-GFitt5C3xVNsTU",
            authDomain: "dehumidification-9ffcc.firebaseapp.com",
            projectId: "dehumidification-9ffcc",
            storageBucket: "dehumidification-9ffcc.firebasestorage.app",
            messagingSenderId: "1052495538194",
            appId: "1:1052495538194:web:8dcd0900994c55c24f10cb"
        };
        
        // å–å¾—ç•¶å‰ç’°å¢ƒçš„ App IDï¼Œè§£æ±º "Missing or insufficient permissions"
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- å…¨åŸŸè®Šæ•¸ ---
        let app, db, auth;
        let userId = null;
        let currentDeviceId = null; // ç•¶å‰é¸ä¸­çš„è£ç½® ID
        let currentDeviceName = "";
        let deviceListenerUnsubscribe = null;
        let logsListenerUnsubscribe = null;
        
        // ç”¨æ–¼æ¨¡æ“¬å¤šè£ç½®èƒŒæ™¯é‹è¡Œçš„æš«å­˜ (device_id -> status_object)
        let backgroundDevicesCache = {}; 

        // Canvas
        const humidityCanvas = document.getElementById('humidity-canvas');
        const ctx = humidityCanvas.getContext('2d');
        const CANVAS_SIZE = 300; // è§£æåº¦æé«˜

        // UI å…ƒç´ 
        const deviceSelect = document.getElementById('device-select');
        const addDeviceBtn = document.getElementById('add-device-btn');
        const renameDeviceBtn = document.getElementById('rename-device-btn');
        const loadingOverlay = document.getElementById('loading-overlay');
        const currentDeviceNameDisplay = document.getElementById('current-device-name');
        
        // Modal å…ƒç´ 
        const addDeviceModal = document.getElementById('add-device-modal');
        const confirmAddDeviceBtn = document.getElementById('confirm-add-device-btn');
        const cancelAddDeviceBtn = document.getElementById('cancel-add-device-btn');
        const newDeviceNameInput = document.getElementById('new-device-name-input');
        const quickAddBtns = document.querySelectorAll('.quick-add-btn');

        // æ§åˆ¶å…ƒä»¶
        const targetHumidityInput = document.getElementById('target-humidity');
        const targetHumidityValue = document.getElementById('target-humidity-value');
        const toggleRunBtn = document.getElementById('toggle-run-btn');
        const modeButtons = document.querySelectorAll('.mode-btn');
        
        // é¡¯ç¤ºå…ƒä»¶
        const deviceStatusIndicator = document.getElementById('device-status-indicator');
        const deviceStatusText = document.getElementById('device-status-text');
        const statusCard = document.getElementById('status-card');
        const currentHumidityDisplay = document.getElementById('current-humidity-display');
        const waterLevelDisplay = document.getElementById('water-level-display');
        const aiDecisionDisplay = document.getElementById('ai-decision-display');
        const pm25Display = document.getElementById('pm25-display');
        const filterLifeDisplay = document.getElementById('filter-life-display');
        const filterProgressBar = document.getElementById('filter-progress-bar');
        const filterStatusAlert = document.getElementById('filter-status-alert');
        const filterLifeText = document.getElementById('filter-life-text');
        const resetFilterBtn = document.getElementById('reset-filter-btn');
        const logArea = document.getElementById('log-area');
        
        // æ’ç¨‹ & å¤–éƒ¨
        const scheduleStartInput = document.getElementById('schedule-start-time');
        const scheduleStopInput = document.getElementById('schedule-stop-time');
        const currentScheduleDisplay = document.getElementById('current-schedule');
        const setStartScheduleBtn = document.getElementById('set-start-schedule-btn');
        const setStopScheduleBtn = document.getElementById('set-stop-schedule-btn');
        const externalTempDisplay = document.getElementById('external-temp');
        const externalHumidityDisplay = document.getElementById('external-humidity');
        const weatherForecastDisplay = document.getElementById('weather-forecast');

        // é è¨­è£ç½®æ¨£æ¿
        const DEFAULT_DEVICE_STATUS = {
            targetHumidity: 55,
            currentHumidity: 65,
            waterLevel: 0.1,
            mode: 'Auto',
            isRunning: false,
            aiDecision: 'å¾…å‘½',
            pm25Level: 20, 
            filterLife: 100,
            scheduleStart: '08:00',
            scheduleStop: '22:00',
            externalTemp: 28.0,
            externalHumidity: 75,
            name: "æ–°é™¤æ¿•æ©Ÿ"
        };

        // --- åˆå§‹åŒ–æµç¨‹ ---
        const initializeFirebase = async () => {
            try {
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken).catch(() => signInAnonymously(auth));
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = `ID: ${userId.slice(0, 6)}...`;
                        
                        // è¨­å®š Canvas
                        const rect = humidityCanvas.getBoundingClientRect();
                        humidityCanvas.width = CANVAS_SIZE;
                        humidityCanvas.height = CANVAS_SIZE;

                        // 1. è¼‰å…¥è£ç½®åˆ—è¡¨
                        await loadDeviceList();

                        // 2. å•Ÿå‹•èƒŒæ™¯æ¨¡æ“¬ (æ›´æ–°æ‰€æœ‰è£ç½®)
                        startGlobalSimulation();

                    } else {
                        document.getElementById('user-id-display').textContent = 'æœªç™»å…¥';
                    }
                });
            } catch (error) {
                console.error("Init Error:", error);
                alert("é€£ç·šå¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†");
            }
        };

        // --- è£ç½®ç®¡ç† ---
        
        // å–å¾—è£ç½®åˆ—è¡¨ä¸¦å¡«å…¥é¸å–®
        const loadDeviceList = async () => {
            if (!userId) return;
            // FIX: ä½¿ç”¨å‹•æ…‹ APP_ID
            const devicesRef = collection(db, `artifacts/${APP_ID}/users/${userId}/devices`);
            
            try {
                const snapshot = await getDocs(devicesRef);
                deviceSelect.innerHTML = ''; // æ¸…ç©ºé¸å–®

                if (snapshot.empty) {
                    // å¦‚æœæ²’æœ‰è£ç½®ï¼Œå»ºç«‹é è¨­è£ç½®
                    await createNewDevice('living_room', 'å®¢å»³');
                    await createNewDevice('bedroom', 'ä¸»è‡¥å®¤');
                    await createNewDevice('basement', 'åœ°ä¸‹å®¤');
                    // é‡æ–°è¼‰å…¥
                    await loadDeviceList();
                    return;
                }

                // å¡«å…¥é¸å–®
                const devices = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    devices.push({ id: doc.id, name: data.name || doc.id });
                    // å¿«å–èƒŒæ™¯æ•¸æ“š
                    backgroundDevicesCache[doc.id] = { ...DEFAULT_DEVICE_STATUS, ...data };
                });

                devices.forEach(dev => {
                    const option = document.createElement('option');
                    option.value = dev.id;
                    option.textContent = dev.name;
                    deviceSelect.appendChild(option);
                });

                // é è¨­é¸å–ç¬¬ä¸€å€‹ (å¦‚æœç•¶å‰æ²’æœ‰é¸å–)
                if (devices.length > 0 && !currentDeviceId) {
                    switchDevice(devices[0].id, devices[0].name);
                } else if (currentDeviceId) {
                     // ä¿æŒç›®å‰çš„é¸æ“‡ï¼Œä½†æ›´æ–°åç¨±
                     const currentDev = devices.find(d => d.id === currentDeviceId);
                     if (currentDev) {
                        deviceSelect.value = currentDeviceId;
                        currentDeviceNameDisplay.textContent = currentDev.name;
                     }
                }

            } catch (e) {
                console.error("Error loading devices:", e);
                // alert("è¼‰å…¥è£ç½®å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ¬Šé™");
            }
        };

        // å»ºç«‹æ–°è£ç½®
        const createNewDevice = async (id, name) => {
            // FIX: ä½¿ç”¨å‹•æ…‹ APP_ID
            const deviceRef = doc(db, `artifacts/${APP_ID}/users/${userId}/devices/${id}`);
            await setDoc(deviceRef, {
                ...DEFAULT_DEVICE_STATUS,
                name: name,
                createdAt: serverTimestamp()
            });
            return id;
        };

        // åˆ‡æ›ç›£æ§çš„è£ç½®
        const switchDevice = (deviceId, deviceName) => {
            if (currentDeviceId === deviceId) return;
            
            loadingOverlay.classList.remove('hidden');
            currentDeviceId = deviceId;
            currentDeviceName = deviceName || deviceId;
            currentDeviceNameDisplay.textContent = currentDeviceName;
            deviceSelect.value = deviceId;

            // å–æ¶ˆèˆŠçš„ç›£è½
            if (deviceListenerUnsubscribe) deviceListenerUnsubscribe();
            if (logsListenerUnsubscribe) logsListenerUnsubscribe();

            // æ¸…ç©º Log
            logArea.innerHTML = '';

            // 1. ç›£è½è©²è£ç½®çš„ç‹€æ…‹
            // FIX: ä½¿ç”¨å‹•æ…‹ APP_ID
            const deviceRef = doc(db, `artifacts/${APP_ID}/users/${userId}/devices/${deviceId}`);
            deviceListenerUnsubscribe = onSnapshot(deviceRef, (docSnap) => {
                loadingOverlay.classList.add('hidden');
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    renderStatus(data);
                    // æ›´æ–°å¿«å–ä¾›æ¨¡æ“¬ä½¿ç”¨
                    backgroundDevicesCache[deviceId] = { ...backgroundDevicesCache[deviceId], ...data };
                }
            });

            // 2. ç›£è½ Log
            // FIX: ä½¿ç”¨å‹•æ…‹ APP_ID
            const logsRef = collection(db, `artifacts/${APP_ID}/users/${userId}/device_logs`);
            
            logsListenerUnsubscribe = onSnapshot(logsRef, (snapshot) => {
                let allLogs = [];
                snapshot.forEach(doc => {
                    const log = doc.data();
                    // ä¿®æ­£: ç¢ºä¿æ¯æ¢ç´€éŒ„éƒ½æœ‰ timestampï¼Œä¸¦åœ¨å‰ç«¯éæ¿¾è£ç½®ID
                    if (log.deviceId === currentDeviceId) {
                         allLogs.push(log);
                    }
                });
                
                // å‰ç«¯æ’åº: æ–°çš„åœ¨å‰
                allLogs.sort((a, b) => {
                    const tA = a.timestamp ? a.timestamp.seconds : 0;
                    const tB = b.timestamp ? b.timestamp.seconds : 0;
                    return tB - tA;
                });

                // å–å‰ 50 ç­†
                renderLogs(allLogs.slice(0, 50));
            }, (error) => console.error(error));
        };

        // --- Modal Logic ---
        const openModal = () => {
            addDeviceModal.classList.remove('hidden');
            newDeviceNameInput.value = '';
            newDeviceNameInput.focus();
        };

        const closeModal = () => {
            addDeviceModal.classList.add('hidden');
        };

        const handleAddDevice = async (name) => {
            if (!name || name.trim() === '') return;
            const finalName = name.trim();
            closeModal();
            loadingOverlay.classList.remove('hidden'); // Show loading briefly
            
            const newId = `device_${Date.now()}`;
            await createNewDevice(newId, finalName);
            await loadDeviceList();
            switchDevice(newId, finalName);
            displayMessage('success', `å·²æ–°å¢åœ°é»ï¼š${finalName}`);
        };

        // æ–°å¢è£ç½®æŒ‰éˆ• (é–‹å•Ÿ Modal)
        addDeviceBtn.addEventListener('click', openModal);

        // Modal å–æ¶ˆ
        cancelAddDeviceBtn.addEventListener('click', closeModal);
        document.getElementById('modal-backdrop').addEventListener('click', closeModal);

        // Modal ç¢ºèª (Input)
        confirmAddDeviceBtn.addEventListener('click', () => {
            handleAddDevice(newDeviceNameInput.value);
        });

        // å¿«é€ŸæŒ‰éˆ•é»æ“Š
        quickAddBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                handleAddDevice(btn.textContent);
            });
        });

        // ä¿®æ”¹è£ç½®åç¨±æŒ‰éˆ•äº‹ä»¶
        renameDeviceBtn.addEventListener('click', async () => {
            if (!currentDeviceId) return;
            
            const newName = prompt("è«‹è¼¸å…¥æ–°çš„è£ç½®åç¨±ï¼š", currentDeviceName);
            
            if (newName && newName.trim() !== "") {
                const cleanName = newName.trim();
                try {
                    // 1. æ›´æ–° Firebase
                    // FIX: ä½¿ç”¨å‹•æ…‹ APP_ID
                    const deviceRef = doc(db, `artifacts/${APP_ID}/users/${userId}/devices/${currentDeviceId}`);
                    await updateDoc(deviceRef, { name: cleanName });
                    
                    // 2. æ›´æ–°æœ¬åœ°è®Šæ•¸
                    currentDeviceName = cleanName;
                    
                    // 3. æ›´æ–° UI é¡¯ç¤º
                    currentDeviceNameDisplay.textContent = cleanName;
                    
                    // 4. æ›´æ–°ä¸‹æ‹‰é¸å–®ä¸­çš„æ–‡å­—
                    const option = deviceSelect.querySelector(`option[value="${currentDeviceId}"]`);
                    if (option) option.textContent = cleanName;

                    // 5. ç´€éŒ„ Log
                    addLog(currentDeviceId, `è£ç½®åç¨±å·²ä¿®æ”¹ç‚º: ${cleanName}`, 'info');
                    displayMessage('success', 'åç¨±ä¿®æ”¹æˆåŠŸ');

                } catch (e) {
                    console.error("Rename failed", e);
                    displayMessage('error', 'ä¿®æ”¹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                }
            }
        });

        // è£ç½®é¸å–®è®Šæ›´äº‹ä»¶
        deviceSelect.addEventListener('change', (e) => {
            const selectedOption = e.target.options[e.target.selectedIndex];
            switchDevice(e.target.value, selectedOption.textContent);
        });

        // --- æ ¸å¿ƒåŠŸèƒ½èˆ‡æ¸²æŸ“ ---

        const updateCurrentDevice = async (updates) => {
            if (!currentDeviceId) return;
            // FIX: ä½¿ç”¨å‹•æ…‹ APP_ID
            const deviceRef = doc(db, `artifacts/${APP_ID}/users/${userId}/devices/${currentDeviceId}`);
            try {
                await updateDoc(deviceRef, updates);
            } catch (e) {
                console.error("Update failed:", e);
            }
        };

        const addLog = async (deviceId, message, type='info') => {
             // FIX: ä½¿ç”¨å‹•æ…‹ APP_ID
             const logsRef = collection(db, `artifacts/${APP_ID}/users/${userId}/device_logs`);
             await setDoc(doc(logsRef), {
                 deviceId: deviceId,
                 message: message,
                 type: type,
                 timestamp: serverTimestamp()
             });
        };

        // æ¸²æŸ“ç‹€æ…‹
        const renderStatus = (status) => {
            // æŒ‰éˆ•èˆ‡ç‹€æ…‹å¡ç‰‡
            const isRunning = status.isRunning;
            const mode = status.mode || 'Manual';

            // Start/Stop Button
            if (isRunning) {
                toggleRunBtn.innerHTML = `<span>ğŸ›‘</span> åœæ­¢é™¤æ¿• (${mode})`;
                toggleRunBtn.className = "w-full py-4 text-xl font-bold text-white rounded-xl shadow-lg transition duration-300 transform hover:scale-[1.02] bg-red-600 hover:bg-red-700 flex justify-center items-center gap-2";
                deviceStatusText.textContent = "é‹è½‰ä¸­";
                deviceStatusText.className = "text-lg font-bold text-amber-600";
                deviceStatusIndicator.className = "w-3 h-3 rounded-full bg-amber-500 shadow-[0_0_10px_rgba(245,158,11,0.8)] animate-pulse";
                statusCard.className = "p-4 rounded-lg bg-amber-50 border border-amber-200";
            } else {
                toggleRunBtn.innerHTML = `<span>ğŸš€</span> å•Ÿå‹•é™¤æ¿•`;
                toggleRunBtn.className = "w-full py-4 text-xl font-bold text-white rounded-xl shadow-lg transition duration-300 transform hover:scale-[1.02] bg-lime-600 hover:bg-lime-700 flex justify-center items-center gap-2";
                deviceStatusText.textContent = "å¾…æ©Ÿä¸­";
                deviceStatusText.className = "text-lg font-bold text-gray-500";
                deviceStatusIndicator.className = "w-3 h-3 rounded-full bg-gray-300";
                statusCard.className = "p-4 rounded-lg bg-gray-100 border border-transparent";
            }

            // Target Humidity
            if (document.activeElement !== targetHumidityInput) {
                targetHumidityInput.value = status.targetHumidity;
            }
            targetHumidityValue.textContent = status.targetHumidity;

            // Mode Buttons
            modeButtons.forEach(btn => {
                if (btn.dataset.mode === mode) {
                    btn.classList.remove('bg-stone-200', 'text-stone-600');
                    btn.classList.add('bg-amber-600', 'text-white', 'shadow-md');
                } else {
                    btn.classList.add('bg-stone-200', 'text-stone-600');
                    btn.classList.remove('bg-amber-600', 'text-white', 'shadow-md');
                }
            });

            // Gauge & Data
            currentHumidityDisplay.textContent = `${status.currentHumidity}%`;
            drawGauge(status.currentHumidity, status.targetHumidity);

            // Water Level
            let waterText = 'æ­£å¸¸';
            let waterColor = 'text-amber-600';
            if (status.waterLevel > 0.8) {
                waterText = 'å³å°‡æ»¿æ°´';
                waterColor = 'text-red-600 animate-pulse';
            } else if (status.waterLevel > 0.5) {
                waterText = 'ä¸­æ°´ä½';
            }
            waterLevelDisplay.textContent = waterText;
            waterLevelDisplay.className = `text-lg font-bold ${waterColor}`;

            // AI Decision
            aiDecisionDisplay.textContent = isRunning ? status.aiDecision : 'ä¼‘çœ ';
            
            // PM2.5
            pm25Display.textContent = `${status.pm25Level}`;
            
            // Filter
            const life = Math.round(status.filterLife);
            filterLifeDisplay.textContent = `${life}%`;
            filterProgressBar.style.width = `${life}%`;
            if (life < 20) {
                filterProgressBar.className = "bg-red-500 h-2.5 rounded-full";
                filterStatusAlert.className = "p-4 rounded-lg bg-red-50 text-red-800 mb-4 border-l-4 border-red-500";
                filterLifeText.textContent = "éœ€æ›´æ›";
                filterLifeText.className = "text-xs bg-red-200 text-red-800 px-2 py-0.5 rounded";
                resetFilterBtn.disabled = false;
            } else {
                filterProgressBar.className = "bg-amber-600 h-2.5 rounded-full";
                filterStatusAlert.className = "p-4 rounded-lg bg-stone-100 text-stone-600 mb-4 border-l-4 border-stone-400";
                filterLifeText.textContent = "è‰¯å¥½";
                filterLifeText.className = "text-xs bg-white px-2 py-0.5 rounded shadow-sm";
                resetFilterBtn.disabled = true;
            }

            // External & Schedule
            externalTempDisplay.textContent = `${status.externalTemp.toFixed(1)}Â°C`;
            externalHumidityDisplay.textContent = `${status.externalHumidity}%`;
            scheduleStartInput.value = status.scheduleStart;
            scheduleStopInput.value = status.scheduleStop;
            currentScheduleDisplay.textContent = `åŒæ­¥å®Œæˆï¼šæ¯æ—¥ ${status.scheduleStart} ~ ${status.scheduleStop}`;
            weatherForecastDisplay.textContent = status.externalHumidity > 80 ? "ğŸŒ§ï¸ æˆ¶å¤–æ½®æ¿•ï¼Œå»ºè­°é—œçª—" : "â›… å¤©æ°£èˆ’é©";

            // Generate Trend Bars
            generateTrendBars(status.currentHumidity);
        };

        const renderLogs = (logs) => {
            logArea.innerHTML = '';
            if (logs.length === 0) {
                logArea.innerHTML = '<div class="text-center text-gray-400 text-sm py-4">å°šç„¡ç´€éŒ„</div>';
                return;
            }
            logs.forEach(log => {
                const div = document.createElement('div');
                const time = log.timestamp ? new Date(log.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--:--';
                
                let icon = 'â„¹ï¸';
                let bgClass = 'bg-stone-50 border-stone-200';
                if (log.type === 'warning') { icon = 'âš ï¸'; bgClass = 'bg-yellow-50 border-yellow-200 text-yellow-800'; }
                if (log.type === 'ai') { icon = 'ğŸ¤–'; bgClass = 'bg-blue-50 border-blue-200 text-blue-800'; }
                if (log.type === 'error') { icon = 'âŒ'; bgClass = 'bg-red-50 border-red-200 text-red-800'; }

                div.className = `p-2.5 rounded border text-sm flex gap-2 items-start ${bgClass}`;
                div.innerHTML = `
                    <span class="opacity-70 text-xs font-mono mt-0.5 whitespace-nowrap">${time}</span>
                    <span class="flex-1">
                        <span class="mr-1">${icon}</span> ${log.message}
                    </span>
                `;
                logArea.appendChild(div);
            });
        };

        // Canvas ç¹ªåœ–
        const drawGauge = (current, target) => {
            const cx = CANVAS_SIZE / 2;
            const cy = CANVAS_SIZE / 2;
            const r = CANVAS_SIZE * 0.4;
            
            ctx.clearRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
            
            // Draw Background Arc
            ctx.beginPath();
            ctx.arc(cx, cy, r, 0.8 * Math.PI, 2.2 * Math.PI);
            ctx.lineWidth = 25;
            ctx.strokeStyle = '#f5f5f4'; // stone-100
            ctx.lineCap = 'round';
            ctx.stroke();

            // Calculate Angle
            const min = 30, max = 80;
            const pct = Math.max(0, Math.min(1, (current - min) / (max - min)));
            const angle = 0.8 * Math.PI + (1.4 * Math.PI * pct);

            // Draw Value Arc
            ctx.beginPath();
            ctx.arc(cx, cy, r, 0.8 * Math.PI, angle);
            let color = '#d97706'; // amber-600
            if (current > target + 10) color = '#dc2626'; // red
            if (current < target - 10) color = '#f59e0b'; // amber-400
            ctx.strokeStyle = color;
            ctx.stroke();

            // Draw Target Indicator
            const targetPct = Math.max(0, Math.min(1, (target - min) / (max - min)));
            const targetAngle = 0.8 * Math.PI + (1.4 * Math.PI * targetPct);
            const tx = cx + r * Math.cos(targetAngle);
            const ty = cy + r * Math.sin(targetAngle);
            
            ctx.beginPath();
            ctx.arc(tx, ty, 8, 0, 2 * Math.PI);
            ctx.fillStyle = '#4b5563';
            ctx.fill();
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#fff';
            ctx.stroke();
        };

        const generateTrendBars = (current) => {
            const container = document.getElementById('trend-chart-placeholder');
            
            // ä¿®æ­£: ç¢ºä¿åˆå§‹åŒ–æœ‰æ±è¥¿
            if (container.children.length === 0) {
                // Initial random bars
                for (let i = 0; i < 20; i++) {
                    const h = Math.random() * 80 + 20;
                    const bar = document.createElement('div');
                    bar.className = "w-full bg-amber-200 rounded-t-sm opacity-60 hover:opacity-100 transition-all";
                    bar.style.height = `${h}%`;
                    container.appendChild(bar);
                }
            } else {
                // ä¿®æ­£: ç”¢ç”Ÿæµå‹•æ•ˆæœ (ç§»é™¤ç¬¬ä¸€å€‹ï¼ŒåŠ å…¥ä¸€å€‹æ–°çš„)
                const bar = document.createElement('div');
                bar.className = "w-full bg-amber-200 rounded-t-sm opacity-60 hover:opacity-100 transition-all";
                // æ–°çš„é«˜åº¦åŸºæ–¼ç•¶å‰æ¿•åº¦ï¼Œç¨å¾®éš¨æ©Ÿæ³¢å‹•
                const h = Math.max(20, Math.min(100, current + (Math.random()*10 - 5)));
                bar.style.height = `${h}%`;
                
                container.appendChild(bar);
                
                // ä¿æŒ bar çš„æ•¸é‡åœ¨ 20 å€‹å·¦å³
                if (container.children.length > 20) {
                    container.removeChild(container.firstElementChild);
                }
            }
        };

        const displayMessage = (type, msg) => {
            const box = document.createElement('div');
            box.className = `fixed top-20 right-4 p-4 rounded shadow-lg text-white font-bold z-50 transform transition-all translate-x-10 ${type === 'error' ? 'bg-red-500' : 'bg-green-600'}`;
            box.textContent = msg;
            document.body.appendChild(box);
            setTimeout(() => { box.classList.remove('translate-x-10'); }, 10);
            setTimeout(() => { box.remove(); }, 3000);
        };

        // --- å…¨åŸŸèƒŒæ™¯æ¨¡æ“¬ (Global Simulation) ---
        const startGlobalSimulation = () => {
            setInterval(() => {
                // éæ­·æ‰€æœ‰å¿«å–ä¸­çš„è£ç½®
                Object.keys(backgroundDevicesCache).forEach(async (devId) => {
                    const status = backgroundDevicesCache[devId];
                    if (!status) return;

                    let updates = {};
                    let shouldUpdate = false;

                    // 1. ç’°å¢ƒè®Šæ•¸éš¨æ©Ÿæ³¢å‹• (æº«åº¦/å¤–éƒ¨æ¿•åº¦)
                    if (Math.random() > 0.7) {
                        updates.externalHumidity = Math.min(100, Math.max(40, status.externalHumidity + (Math.random() * 2 - 1)));
                        shouldUpdate = true;
                    }

                    // 2. å¦‚æœæ©Ÿå™¨åœ¨é‹è½‰ä¸­
                    if (status.isRunning) {
                        // æ¿•åº¦ä¸‹é™ (æ¨¡æ“¬)
                        const drop = (status.currentHumidity - status.targetHumidity) * 0.05 + Math.random() * 0.2;
                        const newHum = Math.max(30, status.currentHumidity - (drop > 0 ? drop : -0.1)); // ç¨å¾®å›å‡å¦‚æœå¤ªä½
                        
                        // æ°´ä½ä¸Šå‡
                        const newWater = Math.min(1.0, status.waterLevel + 0.005);
                        
                        // æ¿¾ç¶²æ¶ˆè€—
                        const newFilter = Math.max(0, status.filterLife - 0.02);

                        updates = { ...updates, currentHumidity: Math.round(newHum), waterLevel: newWater, filterLife: newFilter };
                        shouldUpdate = true;

                        // AI Log è§¸ç™¼ (åƒ…é‡å°ç•¶å‰è£ç½®é¡¯ç¤ºï¼Œé¿å… Log çˆ†ç‚¸ï¼Œä½†åœ¨å¾Œå°é€™æ‡‰è©²å¯«å…¥ DB)
                        // ç‚ºçœè³‡æºï¼Œæˆ‘å€‘åªé‡å°ç•¶å‰æ­£åœ¨çœ‹çš„è£ç½®å¯«å…¥ Log
                        if (devId === currentDeviceId) {
                            if (newWater > 0.95 && status.waterLevel <= 0.95) {
                                addLog(devId, `âš ï¸ æ°´ç®±å³å°‡æ»¿æ°´ï¼Œè«‹æ³¨æ„ï¼`, 'warning');
                            }
                            if (status.mode === 'Auto' && newHum <= status.targetHumidity && status.currentHumidity > status.targetHumidity) {
                                addLog(devId, `ğŸ¤– æ¿•åº¦é”æ¨™ï¼ŒAI é€²å…¥ä½åŠŸè€—æ¨¡å¼`, 'ai');
                            }
                        }
                    } else {
                        // æ²’é–‹æ©Ÿï¼Œæ¿•åº¦æœƒè‡ªç„¶å›å‡ (è¶¨å‘å¤–éƒ¨æ¿•åº¦)
                        if (status.currentHumidity < status.externalHumidity) {
                            updates.currentHumidity = Math.round(status.currentHumidity + 0.1);
                            shouldUpdate = true;
                        }
                    }

                    if (shouldUpdate) {
                        // æ›´æ–°å¿«å–
                        backgroundDevicesCache[devId] = { ...status, ...updates };
                        
                        // å¯«å…¥ Firebase (ç‚ºäº†æ•ˆèƒ½ï¼Œä¸è¦æ¯å€‹è£ç½®æ¯æ¬¡ tick éƒ½å¯«ï¼Œé€™è£¡æ¯ 5 ç§’å¯«ä¸€æ¬¡ï¼Œå‡è¨­ simulation é »ç‡ç‚º 5ç§’)
                        // é€™è£¡ç°¡åŒ–ç‚ºç›´æ¥å¯«å…¥
                        // FIX: ä½¿ç”¨å‹•æ…‹ APP_ID
                        const devRef = doc(db, `artifacts/${APP_ID}/users/${userId}/devices/${devId}`);
                        await updateDoc(devRef, updates);
                    }
                });

            }, 5000); // æ¯ 5 ç§’åŸ·è¡Œä¸€æ¬¡å…¨åŸŸæ¨¡æ“¬
        };

        // --- äº‹ä»¶ç¶å®š ---
        toggleRunBtn.addEventListener('click', () => {
            const newState = !backgroundDevicesCache[currentDeviceId]?.isRunning;
            updateCurrentDevice({ isRunning: newState });
            addLog(currentDeviceId, newState ? 'æ‰‹å‹•å•Ÿå‹•é™¤æ¿•' : 'æ‰‹å‹•é—œé–‰é›»æº', 'info');
        });

        targetHumidityInput.addEventListener('change', (e) => {
            const val = parseInt(e.target.value);
            updateCurrentDevice({ targetHumidity: val });
            addLog(currentDeviceId, `ç›®æ¨™æ¿•åº¦èª¿æ•´ç‚º ${val}%`, 'info');
        });
        targetHumidityInput.addEventListener('input', (e) => targetHumidityValue.textContent = e.target.value);

        modeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const mode = btn.dataset.mode;
                updateCurrentDevice({ mode: mode });
                addLog(currentDeviceId, `åˆ‡æ›è‡³ ${mode === 'Auto' ? 'æ™ºèƒ½' : 'æ‰‹å‹•'} æ¨¡å¼`, 'info');
            });
        });

        resetFilterBtn.addEventListener('click', () => {
            updateCurrentDevice({ filterLife: 100 });
            addLog(currentDeviceId, 'æ¿¾ç¶²å·²é‡ç½®', 'info');
        });

        document.getElementById('set-start-schedule-btn').addEventListener('click', () => {
             updateCurrentDevice({ scheduleStart: scheduleStartInput.value });
             alert("é–‹æ©Ÿæ™‚é–“å·²å„²å­˜");
        });
        document.getElementById('set-stop-schedule-btn').addEventListener('click', () => {
             updateCurrentDevice({ scheduleStop: scheduleStopInput.value });
             alert("é—œæ©Ÿæ™‚é–“å·²å„²å­˜");
        });
        document.getElementById('clear-logs-btn').addEventListener('click', () => {
            logArea.innerHTML = '';
        });

        window.onload = initializeFirebase;
    </script>
</body>
</html>